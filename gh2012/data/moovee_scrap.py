# -*- coding: utf-8 -*-
#
# Copyright 2012, John Lee <john@0xlab.org>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
import csv
import sys
import urllib

from BeautifulSoup import BeautifulSoup


CATEGORIES = {   u'入圍影片': [   {   'id': '50770c1a228a881151d361b7',
                             'title': u'寶米恰恰'},
                         {   'id': '50770c5f228a881151d361b8',
                             'title': u'白鹿原'},
                         {   'id': '50770dbd228a881151d361b9',
                             'title': u'龍飛鳳舞'},
                         {   'id': '50770de2228a881151d361ba',
                             'title': u'大追捕'},
                         {   'id': '50770e0c228a881151d361bb',
                             'title': u'失戀33天'},
                         {   'id': '506c1c77228a881151d3608e',
                             'title': u'浮城謎事'},
                         {   'id': '506c1c85228a881151d3608f',
                             'title': u'神探亨特張'},
                         {   'id': '50770e78228a881151d361bc',
                             'title': u'箭士柳白猿'},
                         {   'id': '506c1c93228a881151d36090',
                             'title': u'奪命金'},
                         {   'id': '50770ec8228a881151d361bd',
                             'title': u'高海拔之戀II'},
                         {   'id': '50770ef5228a881151d361be',
                             'title': u'車手'},
                         {   'id': '503b293f8f7397b2c8b483f8',
                             'title': u'女朋友。男朋友'},
                         {   'id': '503522148f7397b2c8b47d1a',
                             'title': u'星空'},
                         {   'id': '504abe4f8f7397b2c8b48a1f',
                             'title': u'低俗喜劇'},
                         {   'id': '50770f4c228a881151d361bf',
                             'title': u'陣頭'},
                         {   'id': '50770fee228a881151d361c0',
                             'title': u'候鳥來的季節'},
                         {   'id': '50771061228a881151d361c2',
                             'title': u'龍門飛甲'},
                         {   'id': '50771087228a881151d361c3',
                             'title': u'逆戰'},
                         {   'id': '506c1cc8228a881151d36091',
                             'title': u'消失的子彈'},
                         {   'id': '507710df228a881151d361c4',
                             'title': u'華麗之後'},
                         {   'id': '507711ac228a881151d361c6',
                             'title': u'殺生'},
                         {   'id': '50771256228a881151d361c7',
                             'title': u'痞子英雄之全面開戰'},
                         {   'id': '5076fef5228a881151d3619a',
                             'title': u'太極1 從零開始'},
                         {   'id': '50771299228a881151d361c8',
                             'title': u'畫皮II：轉生術'},
                         {   'id': '5075a29e228a881151d36151',
                             'title': u'逆光飛翔'},
                         {   'id': '507712b8228a881151d361c9',
                             'title': u'聽風者'},
                         {   'id': '50815de4228a881151d369ac',
                             'title': u'牽阮的手'},
                         {   'id': '5077144b228a881151d361cc',
                             'title': u'時間之旅'},
                         {   'id': '50771426228a881151d361ca',
                             'title': u'麵包情人'},
                         {   'id': None, 'title': u'三月六日'},
                         {   'id': None, 'title': u'拾荒少年'},
                         {   'id': None, 'title': u'禮物'},
                         {   'id': None, 'title': u'畢業旅行'},
                         {   'id': '50771155228a881151d361c5',
                             'title': u'BBS鄉民的正義'},
                         {   'id': '5077143e228a881151d361cb',
                             'title': u'千錘百煉'},
                         {   'id': '50771039228a881151d361c1',
                             'title': u'愛'}],
    u'影迷嘉年華 / 亞洲爭鳴': [   {   'id': '5076f5f9228a881151d36174',
                                               'title': u'草食男之桃花期'},
                                           {   'id': '5076f61d228a881151d36175',
                                               'title': u'浪漫暴走族'},
                                           {   'id': '5076f715228a881151d36176',
                                               'title': u'不中用的我仰望天空'},
                                           {   'id': '5076f74e228a881151d36177',
                                               'title': u'落KEY人生'},
                                           {   'id': '5076f77b228a881151d36178',
                                               'title': u'小金同志想要飛'},
                                           {   'id': '5076f7af228a881151d36179',
                                               'title': u'妻人太甚'},
                                           {   'id': '5076f7ea228a881151d3617b',
                                               'title': u'風箏孩子王'},
                                           {   'id': '5076f81c228a881151d3617c',
                                               'title': u'精牌大丈夫'},
                                           {   'id': '5075a266228a881151d36150',
                                               'title': u'戀戀大吉嶺'},
                                           {   'id': '5076f886228a881151d3617e',
                                               'title': u'寶萊塢之戀夏雞尾酒'},
                                           {   'id': '5075a09b228a881151d3614c',
                                               'title': u'三個傻瓜限屎專送'},
                                           {   'id': '5076f8ba228a881151d36181',
                                               'title': u'湖心蕩漾三人行'},
                                           {   'id': '5076f9bb228a881151d36182',
                                               'title': u'閃亮女聲'}],
    u'影迷嘉年華 / 名家饗宴': [   {   'id': '5044bf6d8f7397b2c8b4892a',
                                               'title': u'愛．慕'},
                                           {   'id': '50437e118f7397b2c8b4890b',
                                               'title': u'電影社會主義'},
                                           {   'id': '50437e468f7397b2c8b4890d',
                                               'title': u'好戲還在後頭'},
                                           {   'id': '5048bbd78f7397b2c8b489e3',
                                               'title': u'夜色降臨之前'},
                                           {   'id': '50437dcc8f7397b2c8b48908',
                                               'title': u'天使威士忌'},
                                           {   'id': '50437eb58f7397b2c8b4890f',
                                               'title': u'我和你'},
                                           {   'id': '50437f958f7397b2c8b48913',
                                               'title': u'浪蕩世代'},
                                           {   'id': '50437f4c8f7397b2c8b48911',
                                               'title': u'窺孔謎情'},
                                           {   'id': '5076f3f9228a881151d36171',
                                               'title': u'公車上的畢業旅行'},
                                           {   'id': '50759931228a881151d36126',
                                               'title': u'舐夢人'},
                                           {   'id': '5061c5548f7397b2c8b48f34',
                                               'title': u'謊言的烙印'},
                                           {   'id': '50443b9a8f7397b2c8b48923',
                                               'title': u'安娜.卡列尼娜'},
                                           {   'id': '5076f45d228a881151d36172',
                                               'title': u'愛與誠'},
                                           {   'id': '508161b4228a881151d369ae',
                                               'title': u'贖罪'},
                                           {   'id': '50437fd18f7397b2c8b48915',
                                               'title': u'愛,在他鄉'},
                                           {   'id': '5076f56b228a881151d36173',
                                               'title': u'希望之國'}],
    u'影迷嘉年華 / 拉丁狂熱': [   {   'id': '507598b1228a881151d36125',
                                               'title': u'NO'},
                                           {   'id': '50573a888f7397b2c8b48adf',
                                               'title': u'七日哈瓦那'},
                                           {   'id': '5075999d228a881151d3612a',
                                               'title': u'惡童末路'},
                                           {   'id': '50759977228a881151d36129',
                                               'title': u'愛不宜遲'},
                                           {   'id': '5075994a228a881151d36127',
                                               'title': u'露西亞離開之後'},
                                           {   'id': '507599ad228a881151d3612b',
                                               'title': u'我的雙面童年'},
                                           {   'id': '507599bf228a881151d3612c',
                                               'title': u'左派教慾'},
                                           {   'id': '5077000f228a881151d3619e',
                                               'title': u'血光燦爛的日子'},
                                           {   'id': '50759967228a881151d36128',
                                               'title': u'薄霧微光'}],
    u'影迷嘉年華 / 極光掠影': [   {   'id': '5076fdce228a881151d36195',
                                               'title': u'八月三十一日，我在奧斯陸'},
                                           {   'id': '5076fdf6228a881151d36196',
                                               'title': u'歃雪為盟'},
                                           {   'id': '5076fe18228a881151d36197',
                                               'title': u'囧男登大人'},
                                           {   'id': '507599f2228a881151d3612d',
                                               'title': u'愛情摩天輪'},
                                           {   'id': '5076fe7d228a881151d36198',
                                               'title': u'命運談判局'}],
    u'影迷嘉年華 / 歐洲速寫': [   {   'id': '5075a17a228a881151d3614d',
                                               'title': u'如果愛是這樣'},
                                           {   'id': '5076fadd228a881151d36185',
                                               'title': u'再一次初戀'},
                                           {   'id': '5076faf7228a881151d36186',
                                               'title': u'巴黎海狗．冰島靈魂'},
                                           {   'id': '505c86bb8f7397b2c8b48c30',
                                               'title': u'當我們同住一起'},
                                           {   'id': '5075a088228a881151d3614b',
                                               'title': u'狂人大悶鍋'},
                                           {   'id': '5076fb91228a881151d36189',
                                               'title': u'無罪可赦'},
                                           {   'id': '5076fbcd228a881151d3618a',
                                               'title': u'馬甲下的情與慾'},
                                           {   'id': '5076fbf2228a881151d3618b',
                                               'title': u'拼貼幸福'},
                                           {   'id': '5076fc13228a881151d3618c',
                                               'title': u'天堂：愛'},
                                           {   'id': '5075a1a4228a881151d3614e',
                                               'title': u'純真消逝的年代'},
                                           {   'id': '5076fc41228a881151d3618e',
                                               'title': u'週末回家'},
                                           {   'id': '5076fcac228a881151d3618f',
                                               'title': u'嫁禍'},
                                           {   'id': '5071b0df228a881151d360f4',
                                               'title': u'綁架海尼根'},
                                           {   'id': '5076fcdc228a881151d36191',
                                               'title': u'我不在的時候'},
                                           {   'id': '50759a40228a881151d36132',
                                               'title': u'最寂寞的星球'},
                                           {   'id': '5076fd3d228a881151d36192',
                                               'title': u'三生情蛹'}],
    u'影迷嘉年華 / 逐夢美國': [   {   'id': '5076fed9228a881151d36199',
                                               'title': u'南方野獸樂園'},
                                           {   'id': '50759a01228a881151d3612e',
                                               'title': u'性福療程'},
                                           {   'id': '50759a1e228a881151d3612f',
                                               'title': u'親親愛倫'},
                                           {   'id': '505c84aa8f7397b2c8b48c2e',
                                               'title': u'醉生夢醒'}],
    u'影迷嘉年華 / 非洲心聲': [   {   'id': '5075a23a228a881151d3614f',
                                               'title': u'愛在戰火迷亂時'},
                                           {   'id': '5076fa42228a881151d36183',
                                               'title': u'方舟上的夢想家'},
                                           {   'id': '5076faa2228a881151d36184',
                                               'title': u'無人歌頌的懺悔'}],
    u'次文化派對 / 傳奇人生': [   {   'id': '505305d08f7397b2c8b48ac3',
                                               'title': u'搖滾不死：傑森貝克傳奇'},
                                           {   'id': '504cc1cf8f7397b2c8b48a48',
                                               'title': u'如果在法國。一個旅人'},
                                           {   'id': '5075937e228a881151d3611e',
                                               'title': u'甘斯柏之親密自畫像'},
                                           {   'id': '5051e9bf8f7397b2c8b48a95',
                                               'title': u'在雲端上唱歌'},
                                           {   'id': '50759345228a881151d3611d',
                                               'title': u'維多：電影外的同志'}],
    u'次文化派對 / 動畫王國': [   {   'id': '50770915228a881151d361b6',
                                               'title': u'麥兜．噹噹伴我心'},
                                           {   'id': '50770877228a881151d361b4',
                                               'title': u'找死專賣店'},
                                           {   'id': '50770851228a881151d361b3',
                                               'title': u'熊熊遇見小小鼠'}],
    u'次文化派對 / 動畫集錦：瘋狂世界': [   {   'id': None,
                                                              'title': u'偉哉吾兔'},
                                                          {   'id': None,
                                                              'title': u'當我還不是我'},
                                                          {   'id': None,
                                                              'title': u'耶！巴比耶！'},
                                                          {   'id': None,
                                                              'title': u'麥布里奇之弦'},
                                                          {   'id': None,
                                                              'title': u'街童往事'},
                                                          {   'id': None,
                                                              'title': u'艾德蒙你好驢'}],
    u'次文化派對 / 動畫集錦：童趣樂園': [   {   'id': None,
                                                              'title': u'噢,威利...'},
                                                          {   'id': None,
                                                              'title': u'狗狗的生活意見'},
                                                          {   'id': None,
                                                              'title': u'時間及其所創造的'},
                                                          {   'id': None,
                                                              'title': u'尼斯城的怪物'},
                                                          {   'id': None,
                                                              'title': u'一顆偷偷落下的魚眼淚'}],
    u'次文化派對 / 午夜禁地': [   {   'id': '5075981c228a881151d36123',
                                               'title': u'別關燈'},
                                           {   'id': '507597bc228a881151d36122',
                                               'title': u'一千零一魘'},
                                           {   'id': '503ac9628f7397b2c8b48342',
                                               'title': u'厄夜茉莉'},
                                           {   'id': '5075983e228a881151d36124',
                                               'title': u'鍵到鬼'}],
    u'次文化派對 / 性別越界': [   {   'id': '50759a75228a881151d36133',
                                               'title': u'雙面勞倫斯'},
                                           {   'id': '50759f6c228a881151d36146',
                                               'title': u'彩虹保衛隊'},
                                           {   'id': '50759f35228a881151d36145',
                                               'title': u'拉拉手,到白首'},
                                           {   'id': '5075a003228a881151d3614a',
                                               'title': u'看不見的同志'},
                                           {   'id': '50759fe7228a881151d36149',
                                               'title': u'在愛裡'},
                                           {   'id': '50759fbb228a881151d36147',
                                               'title': u'我們的幸福時光'},
                                           {   'id': '50759fd5228a881151d36148',
                                               'title': u'無條件為你'}],
    u'次文化派對 / 經典影事': [   {   'id': '50759a2e228a881151d36130',
                                               'title': u'基努李維之數位任務'},
                                           {   'id': '504cc1138f7397b2c8b48a46',
                                               'title': u'五點到七點的克萊歐'},
                                           {   'id': '507592cd228a881151d3611a',
                                               'title': u'鬼店之237 號房'},
                                           {   'id': '50290b4946949bf4298e5527',
                                               'title': u'鬼店'},
                                           {   'id': '507592b7228a881151d36119',
                                               'title': u'英格麗褒曼vs. 安娜麥蘭妮'},
                                           {   'id': '504cbd7d8f7397b2c8b48a42',
                                               'title': u'義大利之旅'},
                                           {   'id': '5032721b8f7397b2c8b47cb3',
                                               'title': u'黛絲姑娘'},
                                           {   'id': '507592e0228a881151d3611c',
                                               'title': u'阿拉伯的勞倫斯'}],
    u'次文化派對 / 變奏青春': [   {   'id': '507700cf228a881151d361a2',
                                               'title': u'我愛看美眉'},
                                           {   'id': '50759784228a881151d3611f',
                                               'title': u'開膛少女的異想世界'},
                                           {   'id': '507597ac228a881151d36121',
                                               'title': u'愛上你愛上傳'},
                                           {   'id': '5077025f228a881151d361a3',
                                               'title': u'像個男人'},
                                           {   'id': '50759799228a881151d36120',
                                               'title': u'婊妹 Online'},
                                           {   'id': '50770373228a881151d361a6',
                                               'title': u'少年犯'}],
    u'次文化派對 / 音樂啟示錄': [   {   'id': '50770509228a881151d361a7',
                                                  'title': u'安朱鳥：發燒年代'},
                                              {   'id': '507705ad228a881151d361a8',
                                                  'title': u'寂靜之音ECM'},
                                              {   'id': '507705d5228a881151d361a9',
                                                  'title': u'雷鬼教父巴布馬利'},
                                              {   'id': '507705f5228a881151d361aa',
                                                  'title': u'閉嘴聽音樂'},
                                              {   'id': '5077067b228a881151d361ad',
                                                  'title': u'約翰藍儂：紐約城瞬間'},
                                              {   'id': '50771997228a881151d361d9',
                                                  'title': u'在浮城的角落唱首歌'}],
    u'焦點影人 / 克里斯馬克': [   {   'id': '50759e29228a881151d36144',
                                               'title': u'巴黎牆上的貓'},
                                           {   'id': '5075a38a228a881151d36152',
                                               'title': u'塔可夫斯基的一天'},
                                           {   'id': '50759d2f228a881151d36142',
                                               'title': u'日月無光'},
                                           {   'id': '50759d40228a881151d36143',
                                               'title': u'尋亂․黑澤明'},
                                           {   'id': '50759d1f228a881151d36141',
                                               'title': u'紅在革命蔓延時'},
                                           {   'id': '508165f4228a881151d369af',
                                               'title': u'遠離越南'},
                                           {   'id': '50647609fe341c82d7e405e5',
                                               'title': u'堤'}],
    u'焦點影人 / 布里蘭特曼多薩': [   {   'id': '50646efffe341c82d7e405e1',
                                                     'title': u'人質'},
                                                 {   'id': '50759be8228a881151d36137',
                                                     'title': u'阿嬤打官司'},
                                                 {   'id': '50759bdb228a881151d36136',
                                                     'title': u'男孩看見血地獄'},
                                                 {   'id': '50759bce228a881151d36135',
                                                     'title': u'高潮滿座'},
                                                 {   'id': '50759bb6228a881151d36134',
                                                     'title': u'強強'},
                                                 {   'id': '50647200fe341c82d7e405e3',
                                                     'title': u'情慾按摩院'},
                                                 {   'id': '502e86fe46949bf4298e65e5',
                                                     'title': u'出讓丈夫的女人'}],
    u'焦點影人 / 狄奧安哲羅普洛斯': [   {   'id': '50759c0f228a881151d36138',
                                                        'title': u'重構'},
                                                    {   'id': '50759c1c228a881151d36139',
                                                        'title': u'三六年的歲月'},
                                                    {   'id': '502caeca46949bf4298e579f',
                                                        'title': u'流浪藝人'},
                                                    {   'id': '50759c35228a881151d3613a',
                                                        'title': u'獵人'},
                                                    {   'id': '50759c49228a881151d3613b',
                                                        'title': u'亞歷山大大帝'},
                                                    {   'id': '50759c56228a881151d3613c',
                                                        'title': u'塞瑟島之旅'},
                                                    {   'id': '50759c63228a881151d3613d',
                                                        'title': u'養蜂人'},
                                                    {   'id': '50759c70228a881151d3613e',
                                                        'title': u'霧中風景'},
                                                    {   'id': '50759c7e228a881151d3613f',
                                                        'title': u'鸛鳥踟躕'}],
    u'焦點影人 / 荻上直子': [   {   'id': '5071aec5228a881151d360ee',
                                            'title': u'吉貓出租'},
                                        {   'id': '5071aff4228a881151d360f3',
                                            'title': u'廁所'},
                                        {   'id': '5071afe3228a881151d360f1',
                                            'title': u'海鷗食堂'},
                                        {   'id': '5071afd8228a881151d360f0',
                                            'title': u'吉野理髮之家'},
                                        {   'id': '5071afec228a881151d360f2',
                                            'title': u'樂活俱樂部'}],
    u'特別放映': [   {   'id': '5077150d228a881151d361cd',
                         'title': u'寒戰'},
                     {   'id': '50863be6228a881151d36c80',
                         'title': u'聖殤'},
                     {   'id': '5076ce67228a881151d36163',
                         'title': u'少年PI的奇幻漂流'}],
    u'終身成就獎 石雋': [   {   'id': '507715dc228a881151d361ce',
                                       'title': u'大輪迴'}],
    u'華語電影世界 / 中國獨立映像': [   {   'id': '50771783228a881151d361d1',
                                                        'title': u'告訴他們，我乘白鶴去了'},
                                                    {   'id': '507717a4228a881151d361d2',
                                                        'title': u'我還有話要說'},
                                                    {   'id': '50771837228a881151d361d5',
                                                        'title': u'太陽總在左邊'},
                                                    {   'id': '50771858228a881151d361d6',
                                                        'title': u'有人讚美聰慧，有人則不'},
                                                    {   'id': '507717dc228a881151d361d3',
                                                        'title': u'焚屍人'},
                                                    {   'id': '5077187c228a881151d361d7',
                                                        'title': u'鐵蛋兒的情歌'},
                                                    {   'id': '50771805228a881151d361d4',
                                                        'title': u'楊梅洲'},
                                                    {   'id': '5077189f228a881151d361d8',
                                                        'title': u'我故鄉的四種死亡方式'}],
    u'華語電影世界 / 台灣製造': [   {   'id': '50771652228a881151d361cf',
                                                  'title': u'水餃幾兩'},
                                              {   'id': '507716f4228a881151d361d0',
                                                  'title': u'命運狗不理'},
                                              {   'id': None,
                                                  'title': u'即使她們從未相見＋門縫前的包裹＋撿影'},
                                              {   'id': None,
                                                  'title': u'四分人＋狀況排除＋寂寞碼頭'},
                                              {   'id': None,
                                                  'title': u'小夏天＋忐忑＋救命'}],
    u'閉幕片': [   {   'id': '504775ee8f7397b2c8b48971',
                          'title': u'花都魅影'}],
    u'開幕片': [   {   'id': '5075a444228a881151d36153',
                          'title': u'親愛的奶奶'},
                      {   'id': '5075a5d0228a881151d36154',
                          'title': u'甜‧ 祕密'}],
                 }

def screenscrap(url, writer):
    # prepare page mapping
    mp = {}
    f = open('gh_2012_page.txt', 'rb')
    with f:
        reader = csv.reader(f, dialect='excel-tab')
        for row in reader:
            # map movie -> page
            mp[row[0]] = row[2]

    f = urllib.urlopen(url)
    bs = BeautifulSoup(f)
    rows = bs.body.find('div', id='main').find('table').tr.findNextSiblings(True)
    f2 = urllib.urlopen(url + '&lang=en&switch_lang=1')
    en_bs = BeautifulSoup(f2)
    eng_rows = en_bs.body.find('div', id='main').find('table').tr.findNextSiblings(True)
    for row in rows:
        eng_row = eng_rows.pop(0)
        try:
            # 0-date, 1-place, 2-time, 3-ctitle, 4-duration, 5-grade, 6-remark, 7-login
            cols = row.findAll('td')
            remark_mapping = {u'影人出席': '★', u'影片拷貝非英語發音且無英文字幕': '▲', u'已售完': '◎'}
            remark = ''
            span = cols[6].span
            while span:
                if span.span:
                    remark += remark_mapping[span['title']]
                span = span.findNextSibling('span')
            duration = cols[4].string.replace(u'分', '')
            if not cols[3].a:
                continue
            ctitle = cols[3].a.string
            etitle = eng_row.findAll('td')[3].a.string
            page = mp.get(ctitle.encode('utf-8'))
            if not page:
                raise Exception('missing: %s' % ctitle.encode('utf-8'))
            category = '_CATEGORY_'
            link = ''
            for c in CATEGORIES:
                for movie in CATEGORIES[c]:
                    if ctitle == movie['title']:
                        category = c
                        if movie['id']:
                            link = 'http://www.wallagroup.com/movies/%s/' % movie['id']
                        break
        except:
            print >> sys.stderr, 'url: %s\nrow: %s' % (url, row)
            import traceback
            traceback.print_exc()
            sys.exit()
        writer.writerow([
                cols[1].string, cols[0].string, cols[2].string, duration, category.encode('utf-8'),
                ctitle, etitle, cols[5].span.string, remark, page,
#                link,
                ])


def main():
    urls = ['http://www.goldenhorse.org.tw/ui/index.php?class=ghff&func=schedule&subwork=date&search_date=2012-11-%02d' \
               % d for d in xrange(8, 30)]
    writer = csv.writer(sys.stdout, dialect='excel-tab')
    writer.writerow(['PLACE', 'DATE', 'TIME', 'DURATION', 'CATEGORY', 'CTITLE',
                     'ETITLE', 'GRADE', 'REMARK', 'PAGE',
#                     'LINK',
                     ])
    for url in urls:
        screenscrap(url, writer)


if __name__ == '__main__':
    main()
